// Prisma schema for Life Evolutions X Insurance Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
}

// User model with multi-role support
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String
  password      String
  role          UserRole @default(MEMBER)
  phone         String?
  address       String?
  city          String?
  state         String?
  zipCode       String?
  dateOfBirth   DateTime?
  status        UserStatus @default(ACTIVE)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  quotes        Quote[]
  policies      Policy[]
  transactions  Transaction[]
  supportTickets SupportTicket[]
  notifications Notification[]
  agentClients  AgentClient[]
  affiliateReferrals Referral[] @relation("AffiliateReferrals")
  memberReferrals    Referral[] @relation("MemberReferrals")
  applications  Application[]
  
  @@index([email])
  @@index([role])
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  AGENT
  MEMBER
  AFFILIATE
  VIEWER
}

enum UserStatus {
  ACTIVE
  PENDING
  INACTIVE
  SUSPENDED
}

// Quote model for insurance quote requests
model Quote {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  insuranceType InsuranceType
  coverageAmount Decimal  @db.Decimal(12, 2)
  term          Int?     // in years
  premium       Decimal? @db.Decimal(10, 2)
  
  status        QuoteStatus @default(PENDING)
  notes         String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  expiresAt     DateTime?
  
  // Relations
  policy        Policy?
  
  @@index([userId])
  @@index([status])
}

enum InsuranceType {
  LIFE
  HEALTH
  AUTO
  HOME
  BUSINESS
}

enum QuoteStatus {
  PENDING
  APPROVED
  REJECTED
  CONVERTED
  EXPIRED
}

// Policy model for active insurance policies
model Policy {
  id            String   @id @default(cuid())
  policyNumber  String   @unique
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  quoteId       String?  @unique
  quote         Quote?   @relation(fields: [quoteId], references: [id])
  
  insuranceType InsuranceType
  coverageAmount Decimal  @db.Decimal(12, 2)
  premium       Decimal  @db.Decimal(10, 2)
  term          Int      // in years
  
  status        PolicyStatus @default(ACTIVE)
  startDate     DateTime
  endDate       DateTime
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  transactions  Transaction[]
  
  @@index([userId])
  @@index([policyNumber])
  @@index([status])
}

enum PolicyStatus {
  ACTIVE
  PENDING
  LAPSED
  CANCELLED
  EXPIRED
}

// Transaction model for payments
model Transaction {
  id            String   @id @default(cuid())
  transactionId String   @unique
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  policyId      String?
  policy        Policy?  @relation(fields: [policyId], references: [id])
  
  amount        Decimal  @db.Decimal(10, 2)
  type          TransactionType
  method        PaymentMethod
  status        TransactionStatus @default(PENDING)
  
  description   String?
  metadata      Json?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([userId])
  @@index([transactionId])
  @@index([status])
}

enum TransactionType {
  PAYMENT
  REFUND
  COMMISSION
  WITHDRAWAL
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  PAYPAL
  STRIPE
  CASH
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

// Affiliate model
model Affiliate {
  id            String   @id @default(cuid())
  userId        String   @unique
  code          String   @unique
  commission    Decimal  @db.Decimal(5, 2) // percentage
  totalEarnings Decimal  @default(0) @db.Decimal(10, 2)
  status        AffiliateStatus @default(ACTIVE)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  referrals     Referral[]
  
  @@index([code])
}

enum AffiliateStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

// Referral tracking
model Referral {
  id            String   @id @default(cuid())
  affiliateId   String
  affiliate     Affiliate @relation(fields: [affiliateId], references: [id], onDelete: Cascade)
  
  referredUserId String
  referredUser  User     @relation("MemberReferrals", fields: [referredUserId], references: [id], onDelete: Cascade)
  
  commission    Decimal  @db.Decimal(10, 2)
  status        ReferralStatus @default(PENDING)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([affiliateId])
  @@index([referredUserId])
}

enum ReferralStatus {
  PENDING
  APPROVED
  PAID
  REJECTED
}

// Career/Job postings
model Career {
  id            String   @id @default(cuid())
  title         String
  department    String
  location      String
  type          JobType
  description   String
  requirements  String
  salary        String?
  status        JobStatus @default(OPEN)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  closedAt      DateTime?
  
  // Relations
  applications  Application[]
  
  @@index([status])
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  REMOTE
}

enum JobStatus {
  OPEN
  CLOSED
  FILLED
}

// Job applications
model Application {
  id            String   @id @default(cuid())
  careerId      String
  career        Career   @relation(fields: [careerId], references: [id], onDelete: Cascade)
  userId        String?
  user          User?    @relation(fields: [userId], references: [id])
  
  name          String
  email         String
  phone         String
  resume        String   // URL to resume file
  coverLetter   String?
  status        ApplicationStatus @default(PENDING)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([careerId])
  @@index([status])
}

enum ApplicationStatus {
  PENDING
  REVIEWING
  INTERVIEW
  ACCEPTED
  REJECTED
}

// Support tickets
model SupportTicket {
  id            String   @id @default(cuid())
  ticketNumber  String   @unique
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  subject       String
  description   String
  category      TicketCategory
  priority      TicketPriority @default(MEDIUM)
  status        TicketStatus @default(OPEN)
  
  assignedTo    String?
  resolution    String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  resolvedAt    DateTime?
  
  @@index([userId])
  @@index([ticketNumber])
  @@index([status])
}

enum TicketCategory {
  BILLING
  TECHNICAL
  POLICY
  CLAIM
  GENERAL
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING
  RESOLVED
  CLOSED
}

// Notifications
model Notification {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title         String
  message       String
  type          NotificationType
  read          Boolean  @default(false)
  
  createdAt     DateTime @default(now())
  
  @@index([userId])
  @@index([read])
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  POLICY
  PAYMENT
  SYSTEM
}

// Message templates
model Template {
  id            String   @id @default(cuid())
  name          String
  type          TemplateType
  subject       String?
  content       String
  variables     Json?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([type])
}

enum TemplateType {
  EMAIL
  SMS
  WHATSAPP
  NOTIFICATION
}

// Chat requests (live chat/video call)
model ChatRequest {
  id            String   @id @default(cuid())
  sessionId     String   @unique
  type          ChatType
  status        ChatStatus @default(PENDING)
  
  customerInfo  Json?
  agentId       String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  closedAt      DateTime?
  
  @@index([status])
}

enum ChatType {
  LIVE_CHAT
  VIDEO_CALL
}

enum ChatStatus {
  PENDING
  ACTIVE
  CLOSED
}

// Agent-Client relationship
model AgentClient {
  id            String   @id @default(cuid())
  agentId       String
  agent         User     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  clientId      String
  
  commission    Decimal  @db.Decimal(10, 2)
  status        String   @default("active")
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([agentId, clientId])
  @@index([agentId])
}
